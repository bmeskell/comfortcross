<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Comfort Cross ‚Äî Lines Trainer</title>
<style>
  :root { --bg:#0f1221; --panel:#171c36; --text:#f2f4ff; --muted:#aeb6ff; --accent:#91a4ff; --ok:#32d487; --bad:#ff6b6b; }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin:0 auto;padding:22px}
  h1{margin:0 0 14px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#101533;border:1px solid #2a2f57;color:var(--muted);font-size:13px}
  select,button,input[type="file"]{font-size:14px}
  button{cursor:pointer;padding:8px 12px;border-radius:8px;border:1px solid #2a2f57;background:var(--panel);color:var(--text)}
  button:active{transform:translateY(1px)}
  .card{background:var(--panel);border:1px solid #2a2f57;border-radius:12px;padding:16px;margin-top:10px}
  .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
  .cue{font-size:18px;margin:6px 0}
  textarea{width:100%;min-height:100px;border-radius:10px;border:1px solid #2a2f57;background:#0b1030;color:var(--text);padding:10px}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .answer{white-space:pre-wrap;line-height:1.6}
  .flash{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#12173a;border:1px solid #2a2f57;border-radius:10px;padding:10px 14px;display:none}
  .ok{background:#0e2a1e;border-color:#2e6a4e}
  .bad{background:#2a1010;border-color:#6a2e2e}
  .tiny{font-size:12px;color:var(--muted)}
  .drop{margin-top:8px;border:2px dashed #334; border-radius:10px; padding:12px; text-align:center; color:var(--muted)}
  .drop.drag{background:#0b1030}
</style>
</head>
<body>
<div class="wrap">
  <h1>Comfort Cross ‚Äî Lines Trainer</h1>

  <div class="row">
    <span class="pill" id="progress">0 / 0</span>
    <select id="mode">
      <option value="type">Type-to-Check (fuzzy)</option>
      <option value="flash">Flashcard</option>
      <option value="cloze">Cloze</option>
    </select>

    <!-- File input (native, unobstructed) -->
    <input type="file" id="importFile" accept="application/json" />
    <span class="pill" id="fileName">No file chosen</span>

    <button id="exportBtn">Export JSON</button>
    <button id="speakBtn" title="Speak current">üîà Speak</button>
  </div>

  <div class="tiny" style="margin-top:6px">
    Tip: Import <em>comfort_lines_fuzzy.json</em> then choose ‚ÄúType-to-Check (fuzzy)‚Äù. You can also drop a JSON file on the box below.
  </div>

  <!-- Drag & drop zone -->
  <div class="drop" id="dropZone">Drop your JSON here to import</div>

  <div class="card">
    <div class="label">Optional: paste as ‚Äúcue :: line‚Äù, then Load</div>
    <textarea id="pasteBox" placeholder="Erasmus asks about pain :: I have felt naught but joy these seventeen years!..."></textarea>
    <div class="btns">
      <button id="loadFromPaste">Load from Paste</button>
      <button id="clearDeck">Clear Deck</button>
    </div>
  </div>

  <!-- Trainer -->
  <div class="card">
    <div class="label">Cue</div>
    <div class="cue" id="cue">‚Äî</div>

    <!-- Type mode -->
    <div id="typeBox">
      <div class="label">Your answer</div>
      <textarea id="typeInput" placeholder="Type your line here‚Ä¶"></textarea>
      <div class="btns">
        <button id="checkBtn">Check (Enter)</button>
        <button id="revealBtn">Reveal (Space)</button>
        <button id="againBtn">Again (A)</button>
        <button id="goodBtn">Good (G)</button>
      </div>
      <div class="label" style="margin-top:8px">Correct line</div>
      <div class="answer" id="correct">‚Äî</div>
      <div class="tiny" id="score">‚Äî</div>
    </div>

    <!-- Flash mode -->
    <div id="flashBox" style="display:none">
      <div class="answer" id="flashAns">‚Äî</div>
      <div class="btns">
        <button id="flashReveal">Reveal</button>
        <button id="flashAgain">Again</button>
        <button id="flashGood">Good</button>
      </div>
    </div>

    <!-- Cloze mode -->
    <div id="clozeBox" style="display:none">
      <div class="answer" id="clozeMasked">‚Äî</div>
      <textarea id="clozeInput" placeholder="Fill in the missing words‚Ä¶"></textarea>
      <div class="btns">
        <button id="clozeCheck">Check</button>
        <button id="clozeReveal">Reveal</button>
        <button id="clozeAgain">Again</button>
        <button id="clozeGood">Good</button>
      </div>
    </div>
  </div>

  <div class="flash" id="flash">‚Äî</div>
</div>

<script>
(function(){
  // ---------- helpers ----------
  function $(id){ return document.getElementById(id); }
  function flash(msg, kind){
    var f=$('flash');
    f.textContent = msg;
    f.className = 'flash' + (kind ? ' ' + kind : '');
    f.style.display = 'block';
    clearTimeout(f._t); f._t = setTimeout(()=>{ f.style.display='none'; }, 1400);
  }
  function sanitize(s){ return (s||'').replace(/\s+/g,' ').trim(); }
  function lev(a,b){
    a=sanitize(a).toLowerCase(); b=sanitize(b).toLowerCase();
    var m=a.length, n=b.length; if(!m) return n; if(!n) return m;
    var prev=new Array(n+1), cur=new Array(n+1);
    for(var j=0;j<=n;j++) prev[j]=j;
    for(var i=1;i<=m;i++){
      cur[0]=i;
      for(var j=1;j<=n;j++){
        var cost = a[i-1]===b[j-1]?0:1;
        cur[j] = Math.min(cur[j-1]+1, prev[j]+1, prev[j-1]+cost);
      }
      var tmp=prev; prev=cur; cur=tmp;
    }
    return prev[n];
  }
  function sim(a,b){
    var A=sanitize(a), B=sanitize(b), L=Math.max(A.length,B.length)||1;
    return 1 - (lev(A,B)/L);
  }
  function maskCloze(line){
    var ws=line.split(/\s+/);
    return ws.map(function(w,i){
      var bare=w.replace(/[^\w‚Äô'-]/g,'');
      if(bare.length<=3) return w;
      return (i%3===0)? w.replace(/[A-Za-z‚Äô]/g,'_') : w;
    }).join(' ');
  }

  // ---------- state ----------
  var cards=[], idx=0, correct=0, total=0, showAnswer=false;
  var modeSel=$('mode'), progress=$('progress'), fileName=$('fileName');

  function current(){ return cards[idx] || {cue:'‚Äî', line:'‚Äî'}; }
  function update(){
    $('cue').textContent = current().cue || '‚Äî';
    $('correct').textContent = showAnswer? current().line : '‚Äî';
    $('flashAns').textContent = showAnswer? current().line : '‚Äî';
    $('clozeMasked').textContent = maskCloze(current().line);
    $('score').textContent = correct+' correct out of '+total+' attempts';
    progress.textContent = (cards.length? (idx+1):0) + ' / ' + cards.length;

    var m=modeSel.value;
    $('typeBox').style.display = (m==='type')?'':'none';
    $('flashBox').style.display = (m==='flash')?'':'none';
    $('clozeBox').style.display = (m==='cloze')?'':'none';
  }
  function next(again){
    if(!cards.length) return;
    var c = cards[idx];
    cards.splice(idx,1);
    if(again){
      var pos = Math.min(cards.length, Math.max(idx+2,2));
      cards.splice(pos,0,c);
    }else{
      cards.push(c);
    }
    idx = Math.min(idx, cards.length-1);
    showAnswer=false;
    update();
  }

  // ---------- actions ----------
  $('checkBtn').addEventListener('click', function(){
    var s = sim($('typeInput').value, current().line);
    total++;
    if(s>=0.88){ correct++; flash('‚úì '+Math.round(s*100)+'%', 'ok'); next(false); }
    else { flash('‚úó '+Math.round(s*100)+'% ‚Äî try Again or Reveal','bad'); showAnswer=true; update(); }
  });
  $('revealBtn').addEventListener('click', function(){ showAnswer=true; update(); flash('Revealed'); });
  $('againBtn').addEventListener('click', function(){ next(true); });
  $('goodBtn').addEventListener('click', function(){ next(false); });

  $('flashReveal').addEventListener('click', function(){ showAnswer=true; update(); });
  $('flashAgain').addEventListener('click', function(){ next(true); });
  $('flashGood').addEventListener('click', function(){ next(false); });

  $('clozeCheck').addEventListener('click', function(){
    var s = sim($('clozeInput').value, current().line);
    total++;
    if(s>=0.88){ correct++; flash('‚úì '+Math.round(s*100)+'%','ok'); next(false); }
    else { flash('‚úó '+Math.round(s*100)+'%','bad'); showAnswer=true; $('clozeMasked').textContent=current().line; }
  });
  $('clozeReveal').addEventListener('click', function(){ showAnswer=true; $('clozeMasked').textContent=current().line; });
  $('clozeAgain').addEventListener('click', function(){ next(true); });
  $('clozeGood').addEventListener('click', function(){ next(false); });

  $('speakBtn').addEventListener('click', function(){
    try{ var u=new SpeechSynthesisUtterance(current().line); u.rate=.95; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){}
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e){
    if (modeSel.value==='type' && e.key==='Enter'){ e.preventDefault(); $('checkBtn').click(); }
    if (e.code==='Space'){ e.preventDefault(); $('revealBtn').click(); }
    if (e.key==='a' || e.key==='A'){ $('againBtn').click(); }
    if (e.key==='g' || e.key==='G'){ $('goodBtn').click(); }
  });
  modeSel.addEventListener('change', function(){ showAnswer=false; update(); });

  // ---------- JSON import (fixed) ----------
  function importJSONText(txt){
    try{
      var arr = JSON.parse(txt);
      if(!Array.isArray(arr)) throw new Error('Not an array');
      cards = arr.map(function(x){ return {cue:String(x.cue||''), line:String(x.line||'')}; })
                 .filter(function(x){ return x.line.trim().length>0; });
      idx=0; correct=0; total=0; showAnswer=false;
      update();
      flash('Imported '+cards.length+' cards ‚úì','ok');
    }catch(err){
      console.error(err);
      flash('Invalid JSON','bad');
    }
  }

  // Native file picker
  $('importFile').addEventListener('change', function(e){
    var file = this.files && this.files[0] ? this.files[0] : null;
    if(!file){ fileName.textContent='No file chosen'; return; }
    fileName.textContent = file.name;
    var reader = new FileReader();
    reader.onload = function(ev){ importJSONText(String(ev.target.result||'')); };
    reader.onerror = function(){ flash('Could not read file','bad'); };
    reader.readAsText(file);
  });

  // Drag & drop
  var dz=$('dropZone');
  function stopEv(ev){ ev.preventDefault(); ev.stopPropagation(); }
  ;['dragenter','dragover','dragleave','drop'].forEach(function(evt){
    dz.addEventListener(evt, stopEv);
  });
  dz.addEventListener('dragenter', function(){ dz.classList.add('drag'); });
  dz.addEventListener('dragover', function(){ dz.classList.add('drag'); });
  dz.addEventListener('dragleave', function(){ dz.classList.remove('drag'); });
  dz.addEventListener('drop', function(e){
    dz.classList.remove('drag');
    var file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0] ? e.dataTransfer.files[0] : null;
    if(!file){ flash('No file dropped','bad'); return; }
    fileName.textContent = file.name;
    var reader = new FileReader();
    reader.onload = function(ev){ importJSONText(String(ev.target.result||'')); };
    reader.onerror = function(){ flash('Could not read file','bad'); };
    reader.readAsText(file);
  });

  // ---------- Paste loader ----------
  $('loadFromPaste').addEventListener('click', function(){
    var raw = $('pasteBox').value.trim();
    if(!raw){ flash('Nothing to load'); return; }
    var arr=[], lines=raw.split(/\n+/);
    for(var i=0;i<lines.length;i++){
      var ln=lines[i].trim(); if(!ln) continue;
      var m=ln.split('::');
      if(m.length>=2){
        var cue=m[0].trim();
        var line=m.slice(1).join('::').trim();
        if(line) arr.push({cue:cue, line:line});
      }
    }
    if(arr.length===0){ flash('No valid ‚Äúcue :: line‚Äù pairs','bad'); return; }
    cards = arr; idx=0; correct=0; total=0; showAnswer=false; update(); flash('Loaded '+cards.length+' from paste ‚úì','ok');
  });

  $('clearDeck').addEventListener('click', function(){
    cards=[]; idx=0; correct=0; total=0; showAnswer=false; update(); flash('Deck cleared');
  });

  // ---------- boot ----------
  // Tiny demo so the page isn‚Äôt empty before import
  cards = [{cue:'Demo cue: I have felt‚Ä¶', line:'I have felt naught but joy these seventeen years!'}];
  idx=0; update();
})();
</script>
</body>
</html>
