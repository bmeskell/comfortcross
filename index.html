<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Comfort Cross ‚Äî Lines Trainer</title>
<style>
  :root { --bg:#0f1221; --panel:#1a1f3d; --text:#f2f4ff; --muted:#aeb6ff; --accent:#9aa7ff; --ok:#35d07f; --bad:#ff6b6b; }
  html,body { height:100%; margin:0; font-family:system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); }
  .wrap { max-width:980px; margin:0 auto; padding:24px; }
  h1 { margin:0 0 16px; font-size:clamp(20px, 3.8vw, 36px); letter-spacing:.3px; }
  .bar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:12px 0 16px; }
  .bar > * { background:var(--panel); border:1px solid #2a2f57; color:var(--text); padding:8px 10px; border-radius:8px; font-size:14px; }
  select, input[type="file"] { padding:6px 8px; }
  button { cursor:pointer; transition:.15s transform ease; }
  button:active { transform:translateY(1px); }
  .pill { padding:6px 10px; background:#101639; border:1px solid #2a2f57; border-radius:999px; color:var(--muted); }
  .grid { display:grid; grid-template-columns:1fr; gap:12px; }
  .card { background:var(--panel); border:1px solid #2a2f57; border-radius:12px; padding:18px; }
  .label { color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.12em; }
  .cue { font-size:clamp(16px, 2.5vw, 22px); margin:6px 0 2px; }
  .answer { white-space:pre-wrap; font-size:clamp(16px, 2.3vw, 20px); line-height:1.6; }
  .inputRow { display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start; }
  textarea, input[type="text"] { width:100%; padding:12px; background:#0c1030; border:1px solid #2a2f57; color:var(--text); border-radius:10px; }
  .btnRow { display:flex; gap:8px; flex-wrap:wrap; }
  .ok { background:#0e2a1e; border-color:#2e6a4e; }
  .bad { background:#2a1010; border-color:#6a2e2e; }
  .flash { position:fixed; bottom:18px; left:50%; transform:translateX(-50%); padding:10px 14px; border-radius:10px; border:1px solid #2a2f57; background:var(--panel); color:var(--text); box-shadow:0 6px 24px rgba(0,0,0,.35); display:none; }
  .tiny { font-size:12px; color:var(--muted); }
  .muted { color:var(--muted); }
  a { color:var(--accent); }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Comfort Cross ‚Äî Lines Trainer</h1>

    <div class="bar">
      <span class="pill" id="progress">0 / 0</span>
      <select id="mode">
        <option value="type">Type‚Äëto‚ÄëCheck (fuzzy)</option>
        <option value="flash">Flashcard</option>
        <option value="cloze">Cloze (hide words)</option>
      </select>

      <!-- JSON Import / Export -->
      <input type="file" id="importFile" accept="application/json" />
      <button id="exportBtn" title="Export current deck JSON">Export JSON</button>

      <!-- TTS -->
      <button id="speakBtn" title="Speak current answer">üîà Speak</button>
      <span class="tiny">Tip: Import <em>comfort_lines_fuzzy.json</em> then choose ‚ÄúType‚Äëto‚ÄëCheck (fuzzy)‚Äù.</span>
    </div>

    <!-- Paste box (optional) -->
    <div class="card">
      <div class="label">Optional: paste lines (one per line) as <code>cue :: line</code>, then ‚ÄúLoad from Paste‚Äù</div>
      <div class="inputRow" style="margin-top:8px">
        <textarea id="pasteBox" rows="4" placeholder="Erasmus asks about pain :: I have felt naught but joy these seventeen years!..."></textarea>
      </div>
      <div class="btnRow" style="margin-top:8px">
        <button id="loadFromPaste">Load from Paste</button>
        <button id="clearAll">Clear Deck</button>
      </div>
    </div>

    <!-- Trainer UI -->
    <div class="grid" style="margin-top:16px">
      <div class="card">
        <div class="label">Cue</div>
        <div class="cue" id="cue">‚Äî</div>
      </div>

      <div class="card" id="typeBox">
        <div class="label">Your answer</div>
        <div class="inputRow">
          <textarea id="answerInput" rows="5" placeholder="Type your line here‚Ä¶"></textarea>
        </div>
        <div class="btnRow" style="margin-top:8px">
          <button id="checkBtn">Check</button>
          <button id="revealBtn">Reveal</button>
          <button id="againBtn">Again</button>
          <button id="goodBtn">Good</button>
          <span class="tiny muted">Enter = Check ‚Ä¢ Space = Reveal ‚Ä¢ A = Again ‚Ä¢ G = Good</span>
        </div>
        <div class="label" style="margin-top:12px">Correct line</div>
        <div class="answer" id="correctAnswer">‚Äî</div>
        <div class="tiny muted" id="scoreLine">‚Äî</div>
      </div>

      <div class="card" id="flashBox" style="display:none">
        <div class="label">Flashcard</div>
        <div class="answer" id="flashAnswer" style="margin-top:6px">‚Äî</div>
        <div class="btnRow" style="margin-top:8px">
          <button id="flashReveal">Reveal</button>
          <button id="flashAgain">Again</button>
          <button id="flashGood">Good</button>
        </div>
      </div>

      <div class="card" id="clozeBox" style="display:none">
        <div class="label">Cloze (fill‚Äëin)</div>
        <div class="answer" id="clozeMasked" style="margin:6px 0 8px">‚Äî</div>
        <textarea id="clozeInput" rows="3" placeholder="Type the missing words‚Ä¶"></textarea>
        <div class="btnRow" style="margin-top:8px">
          <button id="clozeCheck">Check</button>
          <button id="clozeReveal">Reveal</button>
          <button id="clozeAgain">Again</button>
          <button id="clozeGood">Good</button>
        </div>
      </div>
    </div>

    <p class="tiny muted" style="margin-top:12px">
      JSON format: <code>[{"cue":"Self cue: I have felt‚Ä¶","line":"I have felt naught but joy these seventeen years! ‚Ä¶"}, ‚Ä¶]</code>
    </p>
  </div>

  <div class="flash" id="flash">‚Äî</div>

<script>
(() => {
  // --------- State ---------
  let cards = [];       // [{cue, line}]
  let idx = 0;
  let correct = 0;
  let total = 0;
  let showAnswer = false;

  const $ = sel => document.querySelector(sel);
  const modeSel = $('#mode');
  const cueEl = $('#cue');
  const ansIn = $('#answerInput');
  const corrEl = $('#correctAnswer');
  const scoreLine = $('#scoreLine');
  const progress = $('#progress');
  const speakBtn = $('#speakBtn');

  // Boxes for modes
  const typeBox = $('#typeBox');
  const flashBox = $('#flashBox');
  const clozeBox = $('#clozeBox');

  // Cloze elements
  const clozeMasked = $('#clozeMasked');
  const clozeInput = $('#clozeInput');

  // Flash elements
  const flashAnswer = $('#flashAnswer');

  // Flash banner
  const flashBar = $('#flash');
  function flash(msg, cls='') {
    flashBar.textContent = msg;
    flashBar.style.display = 'block';
    flashBar.style.borderColor = cls==='ok' ? '#2e6a4e' : (cls==='bad' ? '#6a2e2e' : '#2a2f57');
    flashBar.style.background = cls==='ok' ? '#0e2a1e' : (cls==='bad' ? '#2a1010' : 'var(--panel)');
    setTimeout(() => { flashBar.style.display = 'none'; }, 1300);
  }

  // --------- Persistence ---------
  const LS_KEY = 'comfort-trainer-v1';
  function persist() {
    localStorage.setItem(LS_KEY, JSON.stringify({cards, idx, correct, total}));
  }
  function restore() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const s = JSON.parse(raw);
      if (Array.isArray(s.cards)) {
        cards = s.cards;
        idx = s.idx||0; correct = s.correct||0; total = s.total||0;
      }
    } catch {}
  }

  // --------- Utilities ---------
  function sanitize(s){ return (s||'').replace(/\s+/g,' ').trim(); }
  function words(s){ return sanitize(s).toLowerCase().split(' '); }

  // Levenshtein distance (iterative w/ two rows)
  function lev(a,b){
    a = sanitize(a).toLowerCase();
    b = sanitize(b).toLowerCase();
    const m=a.length, n=b.length;
    if(!m) return n; if(!n) return m;
    let prev = new Array(n+1), cur = new Array(n+1);
    for(let j=0;j<=n;j++) prev[j]=j;
    for(let i=1;i<=m;i++){
      cur[0]=i;
      for(let j=1;j<=n;j++){
        const cost = a[i-1]===b[j-1]?0:1;
        cur[j] = Math.min(cur[j-1]+1, prev[j]+1, prev[j-1]+cost);
      }
      [prev,cur]=[cur,prev];
    }
    return prev[n];
  }
  function sim(a,b){
    const A = sanitize(a), B = sanitize(b);
    const L = Math.max(A.length, B.length) || 1;
    return 1 - (lev(A,B) / L); // 0..1
  }
  function maskCloze(line){
    // Hide ~30% of words (every 3rd, skipping tiny words)
    const ws = line.split(/\s+/);
    return ws.map((w,i)=>{
      const bare = w.replace(/[^\w‚Äô'-]/g,'');
      if (bare.length<=3) return w;
      return (i%3===0) ? w.replace(/[A-Za-z‚Äô]/g,'_') : w;
    }).join(' ');
  }

  // --------- Deck ops ---------
  function updateProgress(){
    progress.textContent = `${Math.min(idx+1, cards.length)} / ${cards.length}`;
  }
  function current(){ return cards[idx] || {cue:'‚Äî', line:'‚Äî'}; }
  function next(again=false){
    // Simple spaced repetition: wrong goes +2 ahead; right goes to end
    if (cards.length===0) return;
    const card = cards[idx];
    // Remove current
    cards.splice(idx, 1);
    if (again) {
      const insertAt = Math.min(cards.length, Math.max(idx+2, 2));
      cards.splice(insertAt, 0, card);
    } else {
      cards.push(card); // good -> end
    }
    idx = Math.min(idx, cards.length-1);
    persist();
    showCard();
  }

  // --------- Render ---------
  function showCard(){
    const c = current();
    cueEl.textContent = c.cue || '‚Äî';
    updateProgress();
    scoreLine.textContent = `${correct} correct out of ${total} attempts`;
    const m = modeSel.value;

    typeBox.style.display  = (m==='type') ? '' : 'none';
    flashBox.style.display = (m==='flash') ? '' : 'none';
    clozeBox.style.display = (m==='cloze') ? '' : 'none';

    // Reset displays
    corrEl.textContent = showAnswer ? c.line : '‚Äî';
    ansIn.value = '';
    flashAnswer.textContent = showAnswer ? c.line : '‚Äî';

    if (m==='cloze') {
      clozeInput.value = '';
      clozeMasked.textContent = maskCloze(c.line);
    }
  }

  // --------- Mode handlers ---------
  function checkTyped(){
    const c = current();
    const user = ansIn.value;
    const s = sim(user, c.line);
    total++;
    if (s >= 0.88) { // ~12% edit wiggle room
      correct++;
      flash(`‚úì ${Math.round(s*100)}% match`, 'ok');
      next(false);
    } else {
      flash(`‚úó ${Math.round(s*100)}% ‚Äî try Again or Reveal`, 'bad');
      showAnswer = true;
      corrEl.textContent = c.line;
      persist();
      showCard();
    }
  }

  function speak(text){
    try {
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 0.95;
      u.pitch = 1.0;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    } catch {}
  }

  // --------- Wiring: Buttons ---------
  $('#checkBtn').addEventListener('click', checkTyped);
  $('#revealBtn').addEventListener('click', () => { showAnswer=true; corrEl.textContent=current().line; flash('Revealed'); });
  $('#againBtn').addEventListener('click', () => next(true));
  $('#goodBtn').addEventListener('click', () => next(false));

  $('#flashReveal').addEventListener('click', () => { showAnswer=true; flashAnswer.textContent=current().line; flash('Revealed'); });
  $('#flashAgain').addEventListener('click', () => next(true));
  $('#flashGood').addEventListener('click', () => next(false));

  $('#clozeCheck').addEventListener('click', () => {
    const c = current();
    const s = sim(clozeInput.value, c.line);
    total++;
    if (s >= 0.88) { correct++; flash(`‚úì ${Math.round(s*100)}%`, 'ok'); next(false); }
    else { flash(`‚úó ${Math.round(s*100)}%`, 'bad'); showAnswer=true; clozeMasked.textContent = c.line; }
  });
  $('#clozeReveal').addEventListener('click', () => { showAnswer=true; clozeMasked.textContent=current().line; flash('Revealed'); });
  $('#clozeAgain').addEventListener('click', () => next(true));
  $('#clozeGood').addEventListener('click', () => next(false));

  speakBtn.addEventListener('click', () => speak(current().line));

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && modeSel.value==='type') { e.preventDefault(); $('#checkBtn').click(); }
    if (e.code === 'Space') { e.preventDefault(); $('#revealBtn').click(); }
    if (e.key.toLowerCase() === 'a') { $('#againBtn').click(); }
    if (e.key.toLowerCase() === 'g') { $('#goodBtn').click(); }
  });

  modeSel.addEventListener('change', () => { showAnswer=false; persist(); showCard(); });

  // --------- Import / Export ---------
  // FILE IMPORT (this fixes your issue)
  const imp = document.getElementById('importFile');
  imp.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    const txt = await f.text();
    try {
      const arr = JSON.parse(txt);
      if (!Array.isArray(arr)) throw new Error('Not an array');
      // Normalize {cue,line}
      cards = arr.map(x => ({ cue: String(x.cue||''), line: String(x.line||'') }))
                 .filter(x => x.line.trim().length > 0);
      idx = 0; correct = 0; total = 0; showAnswer = false;
      persist();
      flash(`Imported ${cards.length} cards ‚úì`, 'ok');
      showCard();
    } catch {
      flash('Invalid JSON', 'bad');
    }
    // clear file input so the same file can be re-imported if needed
    e.target.value = '';
  });

  // Export current deck
  $('#exportBtn').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(cards, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'comfort_lines_export.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Load from paste
  $('#loadFromPaste').addEventListener('click', ()=>{
    const raw = $('#pasteBox').value.trim();
    if (!raw) { flash('Nothing to load'); return; }
    const lines = raw.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const arr = [];
    for (const ln of lines) {
      const m = ln.split('::');
      if (m.length >= 2) {
        const cue = m[0].trim();
        const line = m.slice(1).join('::').trim();
        if (line) arr.push({cue, line});
      }
    }
    if (arr.length===0) { flash('No valid ‚Äúcue :: line‚Äù pairs','bad'); return; }
    cards = arr; idx=0; correct=0; total=0; showAnswer=false;
    persist();
    flash(`Loaded ${cards.length} from paste ‚úì`, 'ok');
    showCard();
  });

  $('#clearAll').addEventListener('click', ()=>{
    cards = []; idx=0; correct=0; total=0; showAnswer=false;
    persist();
    showCard();
  });

  // --------- Boot ---------
  restore();
  showCard();

  // If no deck, show a tiny demo card so page isn‚Äôt empty
  if (cards.length===0) {
    cards = [{ cue:'Demo cue: I have felt‚Ä¶', line:'I have felt naught but joy these seventeen years!' }];
    idx=0; correct=0; total=0; showAnswer=false;
    showCard();
  }
})();
</script>
</body>
</html>
